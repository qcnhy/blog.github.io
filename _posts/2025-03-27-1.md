---
layout: post
title: Amh面板Apache2.4编译安装ModSecurity2.9.8
subtitle: 无数失败踩坑记录实现网站访问日志超详细记录
date: 2025-03-27
author: 浅唱
#header-img: img/屏幕截图 2020-10-05 145431.png
catalog: true
tags:
  - 工具
  - 电脑
---

## 前言

测试 NapCat Bot 机器人时，由于 php 代码调用接口复杂，NapCat 本身没有响应日志，只记录请求参数，响应只显示 JSON 解析报错，虽然可以抓包实现，但还是想在服务端设置详细的日志记录，便于分析问题。  
ModSecurity 对 Apache 的支持仅到 2.9.x 版本，3.0.x 版本需要[连接器](https://github.com/owasp-modsecurity/ModSecurity-apache)，但我无法编译成功，且该连接器处于不稳定状态，官方不建议用于生产环境。

## 环境

操作系统：Ubuntu 22.04  
集成环境：AMH 面板 7.2 Apache 2.4

## 项目地址

[https://github.com/owasp-modsecurity/ModSecurity](https://github.com/owasp-modsecurity/ModSecurity)

## 编译安装

    wget https://github.com/owasp-modsecurity/ModSecurity/releases/download/v2.9.8/modsecurity-v2.9.8.tar.gz # 当前 2.9.8 版本为 2.9.x 的最新版本
    tar -xzvf modsecurity-v2.9.8.tar.gz #解压
    cd modsecurity-v2.9.8
    ./autogen.sh
    ./configure --with-apxs=/usr/local/apache-2.4/bin/apxs --with-apr=/usr/local/apache-2.4/bin --with-apu=/usr/local/apache-2.4/bin #这里踩了好多坑
    # 首先apx指定apache的apxs可执行文件路径
    # apr和apu则apr-1-config和apu-1-config的目录路径，死活找到lib里面的apr.exp和apu.exp都是错的
    # 理论上目录路径或者可执行文件路径应该都是可以的，自行尝试下，本次使用目录路径configure通过
    make
    make install # 编译安装之后会自动将文件移动到apache模块目录里面
    chmod 755 /usr/local/apache-2.4/modules/mod_security2.so # 但权限与其他文件不同，为了保持一致，手动修改一下权限

在`/usr/local/apache-2.4/conf/httpd.conf`中加载模块

    LoadModule unique_id_module modules/mod_unique_id.so #内置的模块，被依赖，需要先加载
    LoadModule security2_module modules/mod_security2.so
    Include /usr/local/apache-2.4/conf/mod_security.conf # 引入自定义的配置文件，单独创建方便管理

创建自定义配置文件`/usr/local/apache-2.4/conf/mod_security.conf`内容如下

    SecAuditEngine On
    SecDebugLogLevel 0 # 9最详细，0静默
    SecAuditLogParts ABIJDEFHZ
    SecAuditLogStorageDir /tmp/modsecurity/ # 坑又来了
    SecAuditLogType Concurrent
    SecDebugLog /tmp/modsecurity/modsec_debug.log # 输出调试日志，必须要有
    SecAuditLog /tmp/modsecurity/modsecurity.log # 记录单条日志
    #SecAuditLogType Serial

不论 `SecAuditLogType` 为 `Concurrent` 还是 `Serial` 必有 SecAuditLog 条目 ，为 `Concurrent` 时还需要有 `SecAuditLogStorageDir` 条目

- 其中当 `SecAuditLogType` 为 `Serial` 时 `SecAuditLog` 会记录日志的详细信息，对权限没有要求，会以 root 写入
- 其中当 `SecAuditLogType` 为 `Concurrent` 时 `SecAuditLog` 会记录日志的简要信息，对权限没有要求，会以 root 写入

详细信息则记录到 www 目录下，每个条目一个文件，按时间分类
![](/img/2025-03-27-15-17-43.png)

- `SecAuditLogStorageDir`要求父目录有 `x` 权限 即 `/tmp` 目录，否则 Apache 进程无法进入该目录，即便子目录是 777 ，本目录有 `wx` 权限 即 `/tmp/modsecurity` 目录，模块会自动创建 www 目录，直接修改所有者更为方便

因此，创建日志目录并修改所有者

    mkdir /tmp/modsecurity # 创建日志目录
    chown www:www /tmp/modsecurity # 修改所有者
    apache amh apache restart # 重启或者重载 apache

至此，Apache2.4 ModSecurity2.9.8 编译安装完成，可以正常使用。
